# 定时器/计数器

### CPU 时序的有关知识

①振荡周期：为单片机提供定时信号的振荡源的周期（晶振周期或外加振荡周期）。

②状态周期：2 个振荡周期为1 个状态周期，用S 表示。振荡周期又称S 周期或时钟周期。

③机器周期：1 个机器周期含6 个状态周期，12 个振荡周期。

④指令周期：完成1 条指令所占用的全部时间，它以机器周期为单位。

例如：外接晶振为12MHz 时，51 单片机相关周期的具体值为：
振荡周期=1/12us;
状态周期=1/6us;
机器周期=1us;
指令周期=1~4us;

### 学习定时器前需要明白的几点

①51 单片机有两组定时器/计数器，因为既可以定时，又可以计数，故称之为定时器/计数器。

②定时器/计数器和单片机的CPU 是相互独立的。定时器/计数器工作的过程是自动完成的，不需要CPU 的参与。

③51 单片机中的定时器/计数器是根据机器内部的时钟或者是外部的脉冲信号对寄存器中的数据加1。

有了定时器/计数器之后，可以增加单片机的效率，一些简单的重复加1 的工作可以交给定时器/计数器处理。CPU 转而处理一些复杂的事情。同时可以实现精确定时作用。

## 定时器/计数器原理

STC89C5X 单片机内有两个可编程的定时/计数器T0、T1 和一个特殊功能定时器T2。定时/计数器的实质是加1 计数器（16 位），由高8 位和低8 位两个寄存器THx 和TLx 组成。它随着计数器的输入脉冲进行自加1，也就是每来一个脉冲，计数器就自动加1，当加到计数器为全1 时，再输入一个脉冲就使计数器回零，且计数器的溢出使相应的中断标志位置1，向CPU 发出中断请求（定时/计数器中断允许时）。如果定时/计数器工作于定时模式，则表示定时时间已到；如果工作于计数模式，则表示计数值已满。可见，由溢出时计数器的值减去计数初值才是加1 计数器的计数值。

## 定时器/计数器结构

51 单片机定时器/计数器内部结构如下所示：

![image-20220527180100358](pic\image-20220527180100358.png)

上图中的T0 和T1 引脚对应的是单片机P3.4 和P3.5 管脚。51 单片机定时/计数器的工作由两个特殊功能寄存器控制。TMOD 是定时/计数器的工作方式寄存器，确定工作方式和功能；TCON 是控制寄存器，控制T0、T1 的启动和停止及设置溢出标志。

### 工作方式寄存器TMOD

工作方式寄存器TMOD 用于设置定时/计数器的工作方式，低四位用于T0，高四位用于T1。其格式如下：

![image-20220527180625711](pic\image-20220527180625711.png)

GATE 是门控位, GATE＝0 时，用于控制定时器的启动是否受外部中断源信号的影响。只要用软件使TCON 中的TR0 或TR1 为1，就可以启动定时/计数器工作；GATA＝1 时，要用软件使TR0 或TR1 为1，同时外部中断引脚INT0/1 也为高电平时，才能启动定时/计数器工作。即此时定时器的启动条件，加上了INT0/1 引脚为高电平这一条件。
	C/T :定时/计数模式选择位。C/T ＝0 为定时模式;C/T =1 为计数模式。
	M1M0：工作方式设置位。定时/计数器有四种工作方式。

![image-20220527180808587](pic\image-20220527180808587.png)

### 控制寄存器TCON

TCON 的低4 位用于控制外部中断,已在前面介绍。TCON 的高4 位用于控制定时/计数器的启动和中断申请。其格式如下：

![image-20220527180842695](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220527180842695.png)

TF1（TCON.7）：T1 溢出中断请求标志位。T1 计数溢出时由硬件自动置TF1为1。CPU 响应中断后TF1 由硬件自动清0。T1 工作时，CPU 可随时查询TF1 的状态。所以，TF1 可用作查询测试的标志。TF1 也可以用软件置1 或清0，同硬件置1 或清0 的效果一样。

TR1（TCON.6）：T1 运行控制位。TR1 置1 时，T1 开始工作；TR1 置0 时，T1 停止工作。TR1 由软件置1 或清0。所以，用软件可控制定时/计数器的启动与停止。

TF0（TCON.5）：T0 溢出中断请求标志位，其功能与TF1 类同。
TR0（TCON.4）：T0 运行控制位，其功能与TR1 类同。

## 定时器/计数器的工作方式

### 方式0

方式0 为13 位计数，由TL0 的低5 位（高3 位未用）和TH0 的8 位组成。TL0 的低5 位溢出时向TH0 进位，TH0 溢出时，置位TCON 中的TF0 标志，向CPU发出中断请求。其结构图如下所示：

![image-20220527181119065](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220527181119065.png)

门控位GATE 具有特殊的作用。当GATE=0 时，经反相后使或门输出为1，此时仅由TR0 控制与门的开启，与门输出1 时，控制开关接通，计数开始；当GATE=1时，由外中断引脚信号控制或门的输出，此时控制与门的开启由外中断引脚信号和TR0 共同控制。当TR0=1 时，外中断引脚信号引脚的高电平启动计数，外中断引脚信号引脚的低电平停止计数。这种方式常用来测量外中断引脚上正脉冲的宽度。计数模式时，计数脉冲是T0 引脚上的外部脉冲。计数初值与计数个数的关系为：X=2^13-N。

### 方式1

方式1 的计数位数是16 位，由TL0 作为低8 位，TH0 作为高8 位，组成了16 位加1 计数器。其结构图如下所示：

![image-20220527181155938](pic\image-20220527181155938.png)

计数初值与计数个数的关系为：X=2^16-N。

### 方式2

方式2 为自动重装初值的8 位计数方式。工作方式2 特别适合于用作较
精确的脉冲信号发生器。其结构图如下所示：

![image-20220527181300352](pic\image-20220527181300352.png)

计数初值与计数个数的关系为：X=2^8-N。

### 方式3

方式3 只适用于定时/计数器T0，定时器T1 处于方式3 时相当于TR1=0，停止计数。工作方式3 将T0 分成为两个独立的8 位计数器TL0 和TH0。其结构如下所示：

![image-20220527181341676](pic\image-20220527181341676.png)

这几种工作方式中应用较多的是方式1 和方式2。定时器中通常使用定时器方式1，串口通信中通常使用方式2。

## 定时配置

在使用定时器时，应该如何配置使其工作？其步骤如下（各步骤顺序可任意）：

①对TMOD 赋值，以确定T0 和T1 的工作方式，如果使用定时器0 即对T0 配置，如              果使用定时器1 即对T1 配置。
②根据所要定时的时间计算初值,并将其写入TH0、TL0 或TH1、TL1。
③如果使用中断，则对EA 赋值，开放定时器中断。
④使TR0 或TR1 置位，启动定时/计数器定时或计数。

上述中有一个定时/计数器初值的计算，下面我们来看下如何计算定时/计数器初值。

前面我们介绍过机器周期的概念，它是CPU 完成一个基本操作所需要的时间。其计算公式是：机器周期=1/单片机的时钟频率。51 单片机内部时钟频率是外部时钟的12 分频，也就是说当外部晶振的频率输入到单片机里面的时候要进行12分频。比如说你用的是12MHZ 晶振，那么单片机内部的时钟频率就是12/12MHZ，当你使用12MHZ 的外部晶振的时候，机器周期=1/1M=1us。如果我们想定时1ms的初值是多少呢？1ms/1us=1000。也就是要计数1000 个，初值=65535-1000+1（因为实际上计数器计数到65536（2 的16 次方）才溢出，所以后面要加1）=64536=FC18H，所以初值即为THx=0XFC，TLx=0X18。

知道了如何计算定时/计数器初值，那么想定时多长时间都可以计算出，当然由于定时计数器位数有限，我们不可能直接通过初值定时很长时间，如果要实现很长时间的定时，比如定时1 秒钟。可以通过初值设置定时1ms，每当定时1ms结束后又重新赋初值，并且设定一个全局变量累计定时1ms 的次数，当累计到1000 次，表示已经定时1 秒了。需要其他定时时间类似操作，这样我们就可以使用定时器来实现精确延时来替代之前的delay 函数。





