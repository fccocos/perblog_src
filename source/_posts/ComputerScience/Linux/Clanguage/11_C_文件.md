---
title: 11_C_文件
date: 2022/4/14/ 8:00
categories:
  - 计算机科学与技术
tags:
  - 嵌入式
  - C语言
  - 笔记
sticky: true
valine:
  placeholder: "1. 提问前请先仔细阅读本文档⚡\n2. 页面显示问题💥，请提供控制台截图📸或者您的测试网址\n3. 其他任何报错💣，请提供详细描述和截图📸，祝食用愉快💪"
---



## 文件的概念 

### 文件的定义

**磁盘文件**：指一组相关数据的有序集合存储在外部存储介质上，使用时才调入到内存中

**设备文件：**在操作系统中主机相连的I/O设备都可以看作一个文件

键盘：标准输入文件

屏幕：标准输出文件

在linux操作系统中，每一个外部设备都在/dev目录中有对应的设备文件，想要程序操作设备，就必须对/dev目录中的对应的设备文件进行操作

**标准IO函数库对磁盘文件的读取特点**

```mermaid
graph LR;
程序数据区-内存 -->文件缓冲区-输出-->文件-磁盘
文件-磁盘-->文件缓冲区-输入-->程序数据区-内存
```

### 文件缓冲

文件缓冲区是库函数申请的一段内存，由库函数对其进行操作，程序员没有必要知道存放在哪里，只需知道文件操作的时候有缓冲的特点即可

1. 行缓冲

   标准IO库函数，向标准输出设备（屏幕）输出内容的时候是行缓冲

   所谓的行缓冲就是**缓冲区碰到换行符的时候才刷新缓冲区**

   如果不刷新缓冲区，无法对文件执行读写操作。

   **行缓冲的刷新条件：**

   - 遇到换行符`\n`
   - 程序正常结束
   - 使用`fflush`函数`fflush(stdout)`
   - 当缓冲区满的时候，含缓冲区默认大小为1024 Byte

2. 全缓冲

   标准IO库函数，向普通文件读写数据的时候，是全缓冲，碰到换行符也不刷新缓冲区，只有缓冲区满了，才刷新缓冲区

   全缓冲的刷新情况：

   1. 缓冲区满了，刷新缓冲区
   2. 人为刷新缓冲区 `fflush(文件指针)`
   3. 程序正常结束，会刷新缓冲区

3. 无缓冲

   在读写文件的时候通过系统调用IO(read write)，对文件进行读写数据，这个时候是无缓冲的，即数据会立马进入文件，读数据会立马进入内存

**写文件的流程**

应用程序空间-->内核空间-->驱动程序-->硬盘上

应用程序和内核程序运行在不同的空间里。目的是为了保护内核

**设置缓冲区的目的**

通过缓冲可以减少进出内核的次数，提高效率

### 磁盘文件的分类

一个文件通常是磁盘上一段命名的存储区，计算机的存储在物理上是二进制的，所以物理上所有的磁盘文件本质上都是一样的；以字节为单位进行顺序存储。

从用户或者操作系统使用的角度（逻辑上）把文件分为：

文本文件：基于字符编码的文件

二进制文件：基于值编码的文件

#### 文本文件

基于字符编码，常见编码有ASCII、UNICODE等，一般使用文本编辑器直接打开

#### 二进制文件

基于值编码，根据具体应用，指定某个值是什么意思，把内存中的数据按其在内存中的存储形式原样输出到磁盘上，一般需要判断或使用特定软件分析数据格式

#### 文本文件和二进制文件的对比

- 译码
  - 文本文件编码基于字符定长，译码容易
  - 二进制文件编码是变长的，译码难度大，不同二进制文件格式，不同的译码方式
- 空间利用率
  - 二进制文件用一个比特来代表一个意思（位操作）
  - 文本文件任何一个意思至少是一个字符
  - 二进制文件空间利用率高
- 可读性
  - 文本文件用通用的记事本工具几乎可以浏览所有文本文件
  - 二进制文件需要一个具体的文件解码器



### 总结

文件在硬盘上存储的时候，物理上都是用二进制来存储的

标准IO库函数，对文件操作的时候，不管文件的编码格式，而是按照字节对文件进行读写，所以文件又叫流式文件，即把文件看成字节流

## 文件指针

文件指针在程序中用来标识一个文件的，在打开文件的时候得到文件指针，文件指针就是用来代表打开的文件

对文件进行读、写、关闭等操作的时候，对文件指针进行操作即可，即将文件指针，传给读、写、关闭等函数，这些函数就知道对哪一个文件进行操作

**定义文件指针的一般形式**：

```c
FILE* 指针变量标识符;
FILE为大写，需要包含<stdio.h>
```

FILE是系统使用typedef定义出来的有关文件信息的一种结构体类型，结构体中含有文件名、文件状态和文件当前位置等信息

 一般情况下，我们操作文件前必须定义一个文件指针标识需要操作的文件

*实际编程中使用库函数操作文件，无需关系FILE结构体的细节，只需要将文件指针传给IO库函数，库函数再通过FILE结构体里的信息对文件进行操作*

**FILE在stdio.h文件中的文件类型声明：**

```c
typedef struct {
    short level; //缓冲区"满"或"空"的程度
    unsigned flags; //文件状态标志
    char fd; //文件描述符
    unsigned char hold; //如无缓冲区不读取字符
    short bsize;//缓冲区的大小
    unsigned char *buffer;//数据缓冲区的位置
    unsigned ar* curp;//指针，当前的指向
    unsigned istemp; //临时文件，指示器
    short token;//用于有效性检查
}FILE;
```

在缓冲文件系统中，每一个被使用的文件都要在内存中开辟一块FILE类型的区域，存放与操作文件有关的信息

**对文件操作的步骤**：

1. 对文件进行读写等操作之前要打开文件得到文件指针
2. 通过文件指针对文件进行读写等操作
3. 读写等操作完毕后，要关闭文件，关闭文件后，就不能在通过次问价指针操作文件了

C语言中有三个特殊的文件指针无需定义，在程序中可以直接使用

**stdin:** 标准输入 默认为当前终端(键盘)

我们使用的scanf、getchar函数默认从此终端获取数据

**stdout:** 标准输出 默认为当前终端（屏幕）

我们使用的printf、puts函数默认输出信息到此终端

**stderr:** 标准错误输出设备文件 默认为当前终端(屏幕)

程序使用perror函数的时候信息打印到此终端

## 文件操作

### 打开文件`fopen`

**函数定义：**`FILE* fopen(const char* path,const char* mode);`

**函数说明:** `fopen`函数的功能是打开一个已经存在的文件，并返回这个文件的文件指针，或者创建一个文件，并打开此文件，然后返回此文件的文件指针

**函数的参数：**

参数1：打开文件的路径

1. 绝对路径：从根目录开始到当前文件的路径名称"/home/edu/text/text1.txt"
2. 相对路径："./test/text.txt"

参数2：文件打开的方式，即以什么样的方式（只读、只写、可读可写等）打开文件。第二个参数几种形式（打开文件的方式）`r w a +`

| 模式    | 功能                                                         |
| ------- | ------------------------------------------------------------ |
| r或rb   | 以只读方式打开一个文本文件（不创建文件）                     |
| w或wb   | 以写方式打开文件（使文件长度截断为0字节，创建一个文件）      |
| a或ab   | 以添加的方式打开文件，即在末尾添加内容，当文件不存在时，创建用于写 |
| r+或rb+ | 以可读可写的方式打开文件（不创建文件）                       |
| w+或wb+ | 以可读可写的方式打开文件（使文件长度为0字节，创建一个文件    |
| a+或ab+ | 以添加方式打开文件，打开文件并在末尾更改文件（如果文件不存在，则创建文件 |

**返回值：**成功返回文件指针，失败返回NULL

### 关闭文件`fclose`

函数头文件：`#include <stdio.h>`

函数定义：`int fclose(FILE* fp)`

函数说明: 关闭fp所代表的文件

注意一个文件只能关闭一次，不能多次关闭。关闭文件之后就不能使用文件指针对文件进行操作了

返回值：成功返回0  失败返回非0

注意可以通过返回值来判断关闭文件是否成功。

### 读文件`fread`

函数定义：`size_t fread(void *ptr, size_t size, size_t nmemb, FILE* stream);`

函数说明：`fread`函数从stream所标识的文件中读取数据，一块是size个字节，共`nmemb`块，存放到`ptr`指向的内存里

返回值：实际读取到的块数

### 写文件`fwrite`

函数定义：`size_t fwrite(void *ptr, size_t size, size_t nmemb, FILE *stream);`

函数说明：`fwrite`函数将ptr指向的内存里的数据，向stream所标识的文件中写入数据，一块是size个字节，共`nmemb`块

返回值：实际写入的块数

### 格式化读写文件函数

#### 函数调用：

`fprintf(文件指针，格式字符串，输出列表)`

`fscanf(文件指针，格式字符串，输出列表)`

#### 函数功能

从磁盘文件中读写字符

`fprintf`将数据输出到文件指针所指定的文件

`fscanf`从文件指针所标识的文件中获取输入

### 随机读写

`rewind`将文件的偏移量指向文件的开始位置 `void rewind(文件指针)`

`ftell`计算文件读写位置距离文件开始有多少个位置`long ftell(文件指针)`

`fseek`定位位置指针（读写位置）





## 读取字符

### 一次读取一个字符

函数定义：`int fgetc(FILE* stream);`

函数说明：`fgetc`从stream所标识的文件中读取一个字节，将字节值返回

返回值：

- 以t的方式：读到文件结尾返回`EOF`
- 以b的方式：读到文件结尾，使用`feof`判断结尾

函数定义：`int fputc(int c, FILE *stream)`

函数说明：`fputc`将c的值写到stream所代表的文件中

返回值：成功，返回输出字节数；失败，返回`EOF`

`EOF`是在`stdio.h`文件中定义的符号常量，值为-1

<u>*注意：打开文件的时候，默认读写位置在文件的开始位置，如果以a的方式打开读写位置在文件的末尾，向文件中读取字节或写入字节的时候，读写位置会往文件的末尾方向偏移，读写多少个字节，读写位置就往文件的末尾方向偏移多少个字节*</u>

### 一次读取一个字符串

函数定义：`char* fgets(char* s, int size, FILE* stream)`

函数说明：从stream所指的文件中读取字符，在读取的时候碰到换行符或则是碰到文件的末尾停止读取，或者是读取了size-1个字节停止读取，在读取的内容后面会加一个'\0'，作为字符串的结尾

返回值：成功返回数组首地址，失败返回NULL

函数定义：`int fputs(const char*s, FILE *stream)`

函数说明：将s指向的字符串，写到stream代表的文件中

返回值：成功返回写入的字符个数，失败返回-1
